name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write
  packages: write

jobs:
  # ---- Build & Verify ----
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci
      - run: cd web && npm ci
      - run: npm run build -w packages/sdk
      - run: npm run typecheck
      - run: npm run build
      - run: node dist/cli/index.js --help

      - uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  # ---- Publish to npm ----
  publish-npm:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org
          cache: npm

      - run: npm ci
      - run: cd web && npm ci

      - uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ---- Publish SDK to npm (if version changed) ----
  publish-sdk:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org
          cache: npm

      - name: Check if SDK version needs publishing
        id: check
        run: |
          LOCAL=$(node -p "require('./packages/sdk/package.json').version")
          REMOTE=$(npm view @teleton-agent/sdk version 2>/dev/null || echo "0.0.0")
          echo "local=$LOCAL" >> "$GITHUB_OUTPUT"
          echo "remote=$REMOTE" >> "$GITHUB_OUTPUT"
          if [ "$LOCAL" != "$REMOTE" ]; then
            echo "publish=true" >> "$GITHUB_OUTPUT"
          else
            echo "publish=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install root deps (for @types/node hoisting)
        if: steps.check.outputs.publish == 'true'
        run: npm ci

      - name: Build and publish SDK
        if: steps.check.outputs.publish == 'true'
        run: npm run build -w packages/sdk && cd packages/sdk && npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ---- Publish Docker image ----
  publish-docker:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version and repo
        id: meta
        run: |
          echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"
          echo "repo=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ steps.meta.outputs.repo }}:${{ steps.meta.outputs.version }}
            ghcr.io/${{ steps.meta.outputs.repo }}:latest

  # ---- GitHub Release ----
  create-release:
    needs: [publish-npm]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git tag --sort=-version:refname | head -2 | tail -1)
          if [ -z "$PREV_TAG" ]; then
            LOG=$(git log --oneline)
          else
            LOG=$(git log --oneline "$PREV_TAG"..HEAD)
          fi
          echo "log<<EOF" >> "$GITHUB_OUTPUT"
          echo "$LOG" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          body: |
            ## Install

            **npm:**
            ```bash
            npm install -g teleton
            ```

            **Docker:**
            ```bash
            docker run -it -v ~/.teleton:/data ghcr.io/${{ github.repository }}:latest setup
            ```

            ## Changes
            ${{ steps.changelog.outputs.log }}
